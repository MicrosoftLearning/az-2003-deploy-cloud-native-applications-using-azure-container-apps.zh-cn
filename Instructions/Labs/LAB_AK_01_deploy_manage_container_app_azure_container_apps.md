---
lab:
  title: 实验室：使用 Azure 容器应用部署和管理容器应用
  type: Answer Key
  module: 'Module 6: Deploy and manage a container app using Azure Container Apps'
---

# 实验室：使用 Azure 容器应用部署和管理容器应用
# 学生实验室答案要点

## 说明

在本实验室中，你将使用 Azure 容器应用来部署和管理应用。 若要实现该解决方案，首先要配置一个组合使用本地工具和 Azure 资源的开发环境。 准备好环境后，请使用 Azure 容器注册表、Azure 容器应用和 Azure Pipelines 来部署和管理应用。  

完成本实验室的学习后，你将能够：

1. 配置 Azure 容器注册表与 Azure 容器应用之间的安全连接。
1. 在 Azure 容器应用中创建和配置容器应用。
1. 使用 Azure Pipelines 配置持续集成。
1. 在 Azure 容器应用中缩放已部署的应用。
1. 在 Azure 容器应用中管理修订。

### 练习 1：配置 Azure 资源

在本练习中，你将配置支持 Azure 容器应用解决方案的 Azure 资源。

完成以下任务大约需要 10-15 分钟：

- 检查资源组设置。
- 使用子网配置 Azure 虚拟网络。
- 配置 Azure 服务总线资源。
- 配置 Azure 容器注册表资源。

#### 任务 1：检查资源组设置

完成以下步骤，以检查本实验室中使用的资源组的位置设置。

1. 在实验室环境中，打开浏览器窗口，然后导航到 Azure 门户：`https://portal.azure.com/`

    如果在使用适合本实验室的订阅/帐户登录 Azure 门户的过程中需要帮助，请与课堂讲师合作。

1. 在 Azure 门户主页的“导航”下，选择“资源组”********。

1. 在“资源组”页面上，选择“RG1”****。

    如果尚未创建 RG1 资源组，请立即创建它。

1. 记下分配给 RG1**** 资源组的“位置”**** 设置。

    在本实验室中创建其他 Azure 资源时，你将使用相同的位置/区域。

1. 关闭“RG1”**** 页面，然后关闭“资源组”**** 页面。

#### 任务 2：创建虚拟网络和子网

完成以下步骤来配置虚拟网络和子网。

1. 在 Azure 门户顶部的搜索栏中，在“搜索”文本框中输入“虚拟网络”。****

1. 在搜索结果中，选择“虚拟网络”。****

1. 选择“创建虚拟网络”。****

1. 在“基本信息”选项卡上，如下所示配置虚拟网络：

    - 订阅：确保选择你用于此引导式项目的 Azure 订阅。
    - 资源组名称：选择 RG1****
    - 虚拟网络名称：输入 VNET1****
    - 区域：确保指定的“区域”与资源组的位置设置匹配。

1. 选择“IP 地址”选项卡。****

1. 在“IP 地址”选项卡上，在“子网”下选择“默认”。********

1. 在“编辑子网”页上，如下所示配置子网：

    - 名称：输入 **`PESubnet`**
    - 起始地址：确保指定 10.0.0.0。****
    - 子网大小：确保指定 /24（256 个地址）。****

    第一个子网将用于专用终结点（Azure 容器注册表）。

1. 选择“保存”。

1. 在“IP 地址”选项卡上，选择“+ 添加子网”。****

1. 在“添加子网”页上，如下所示配置子网：

    - 名称：输入 **`ACASubnet`**
    - 起始地址：确保指定 10.0.4.0。****
    - 子网大小：确保指定 /23（512 个地址）。****

    Azure 容器应用的子网需要一个大于 256 的地址空间。

1. 选择 **添加** 。

1. 选择“查看 + 创建”。

1. 在验证通过后，选择“创建”。****

1. 等待部署完成，然后关闭 VNET1 页。

#### 任务 3：配置服务总线

完成以下步骤来配置一个服务总线实例。

1. 在 Azure 门户顶部的搜索栏中，在“搜索”文本框中输入“服务总线”。****

1. 在搜索结果中，选择“服务总线”。****

1. 选择“创建服务总线命名空间”。****

1. 在“基本信息”选项卡上，如下所示配置服务总线命名空间：

    - 订阅：确保选择你用于此引导式项目的 Azure 订阅。
    - 资源组名称：选择 RG1****
    - 命名空间名称：输入 sb-az2003-，后跟你的姓名首字母缩写和日期。**** 例如 sb-az2003-cah12oct。****
    - 位置：确保指定的“位置”与资源组的位置设置匹配。
    - 定价层：选择“基本”****。

1. 选择“查看 + 创建”。

1. 显示“验证成功”消息后，选择“创建”。****

1. 等待部署完成，然后关闭“服务总线命名空间”页。

#### 任务 4：配置 Azure 容器注册表

完成以下步骤来配置容器注册表实例。

1. 在 Azure 门户顶部的搜索栏中，在“搜索”文本框中输入“容器注册表”。****

1. 在搜索结果中，选择“容器注册表”。****

1. 在“容器注册表”页上，选择“创建容器注册表”或“+ 创建”。********

1. 在“创建容器注册表”页的“基本信息”选项卡上，指定以下信息：

    > [!NOTE]
    > 注册表的名称必须唯一。 此外，与专用终结点的专用链接需要高级层级。

    - 订阅：确保选择你用于此引导式项目的 Azure 订阅。
    - 资源组：选择 RG1。****
    - 注册表名称：输入 acraz2003，后跟你的姓名首字母缩写和日期。**** 例如 acraz2003cah12oct****
    - 位置：确保指定的“位置”与资源组的位置设置匹配。
    - SKU：选择“高级”。****

1. 选择“查看 + 创建”。

1. 显示“已通过验证”消息后，选择“创建”。****

1. 部署完成后，打开容器注册表资源。

1. 在“容器注册表”页面的左侧菜单上的“设置”**** 下，选择“网络”****。

1. 在“网络”页上的“公共访问”选项卡上，确保已选择“所有网络”。****

1. 在左侧菜单上的“设置”下选择“属性”。********

1. 在“属性”页上，选择“管理员用户”****，然后选择“保存”。****

1. 关闭“容器注册表”页。

1. 关闭 Azure 门户（浏览器）窗口。

### 练习 2：在主机环境中配置开发人员工具

在本练习中，请确保在虚拟机上正确配置脚本和开发人员工具。

完成以下任务大约需要 20-25 分钟：

- 配置 Azure CLI 扩展。
- 安装 Docker Desktop。
- 安装 .NET 8 SDK。
- 更新 Visual Studio Code 并配置扩展。

#### 任务 1：卸载 Visual Studio Code

完成以下步骤以卸载 Visual Studio Code。

1. 打开 Windows“开始”菜单。

1. 在开始菜单上，选择**设置**。

1. 在左侧菜单上选择“应用”****，然后选择“已安装的应用”****。

1. 找到“Microsoft Visual Studio Code”****。

1. 在 Microsoft Visual Studio Code 右侧选择省略号 (...)，然后选择“卸载”****。

1. 在弹出窗口中选择“卸载****”。

1. 出现提示时，选择“是”****，然后选择“确定”****。

1. 关闭设置。

#### 任务 2：配置 Azure CLI 扩展

完成以下步骤以配置 Azure CLI。

1. 打开命令行或终端应用程序，例如 Windows 命令提示符。

1. 使用 `az login` 命令登录到 Azure。

    此时会打开一个浏览器窗口，用于选择 Azure 帐户。

1. 根据提示完成身份验证过程。

1. 关闭浏览器窗口。

1. 在命令行应用中，若要安装 Azure 容器应用扩展，请输入以下命令：`az extension add --name containerapp --upgrade`

1. 关闭命令行应用。

#### 任务 3：安装 Docker 桌面

完成以下步骤以安装 Docker Desktop。

1. 打开浏览器窗口，然后导航到 Docker Desktop 安装页：`https://docs.docker.com/desktop/install/windows-install/`

1. 选择“Windows 版 Docker Desktop”**** 并等待安装程序文件下载。

1. 打开下载的安装程序文件，然后按照在线说明安装 Docker Desktop。

    安装过程大约需要 5 分钟。

1. 安装完成后，选择“关闭并重启”****。

1. 更新后的虚拟机重启时，等待出现“Docker 订阅服务协议”**** 窗口。

1. 在“Docker 订阅服务协议”页上，选择“接受****”。

1. 在“完成 Docker Desktop 设置”页上，选择“完成”****。

1. 在“用户帐户控制”页上，选择“是”。****

1. 在“欢迎使用 Docker Desktop”页上，选择“继续而不登录”****。

1. 在“告诉我们你所做的工作”页上，选择“跳过”****。

1. 等待 Docker Engine 启动过程完成，然后最小化 Docker Desktop 应用。

    不要关闭 Docker Desktop，只需最小化正在运行的应用即可。

#### 任务 4：安装 .NET 8 SDK

完成以下步骤来安装 .NET 8 SDK。

1. 打开 Web 浏览器窗口，然后导航到 .NET 8 SDK 下载页：`https://dotnet.microsoft.com/download`

1. 选择“.NET SDK x64”****

1. 下载完成后，打开安装文件并按照在线说明安装 .NET 8 SDK。

1. 关闭浏览器窗口。

#### 任务 5：使用 C#、Docker 和 Azure 应用服务扩展配置 Visual Studio Code

完成以下步骤，以使用扩展配置 Visual Studio Code。

1. 打开 Web 浏览器窗口，然后导航到 Visual Studio Code 下载页：`https://code.visualstudio.com/download`

1. 选择“Windows”****，并等待安装程序文件下载。

1. 打开 Visual Studio Code 安装程序文件。

1. 接受许可协议，然后继续接受默认设置，直到完成安装。

1. 打开 Visual Studio Code。

1. 选择“活动栏”上的“扩展”。

    活动栏是 Visual Studio Code 用户界面左侧的垂直菜单。

1. 在“在市场中搜索扩展”文本框中，输入“C#”

    输入“C#”会筛选扩展列表，以仅显示与 C# 编码有关联的扩展。

1. 在可用扩展的筛选列表中，选择 Microsoft 发布的标有“**C# 开发工具包** - Microsoft 的官方 C# 扩展”的扩展。

1. 要安装扩展，请选择“安装”。

1. 等待安装完成。

    安装 C# 开发工具包大约需要 1 分钟。

1. 在“扩展”视图中，将“C#”替换为“docker”。************

1. 在筛选后的可用扩展列表中，选择 Microsoft 发布的标记为“Docker”的扩展。****

1. 要安装扩展，请选择“安装”。

1. 在“扩展”视图中，将“docker”替换为“Azure 应用服务”。************

1. 在筛选后的可用扩展列表中，选择 Microsoft 发布的标记为“Azure 应用服务”的扩展。****

1. 要安装扩展，请选择“安装”。

1. 关闭 Visual Studio Code。

### 练习 3：创建和配置应用部署资源

在本练习中，你将配置 Azure DevOps 项目和 Azure Pipeline，创建 Docker 映像并将其推送到容器注册表，然后部署自承载 Windows 代理。

完成以下任务大约需要 40 分钟：

- 配置 Azure DevOps 项目并初始化代码存储库。
- 创建 .NET 应用并同步到 Azure DevOps 存储库。
- 创建 Docker 映像并将该映像推送到 Azure 容器注册表。
- 创建一个名为 Pipeline1 的 Azure 管道。
- 部署自托管 Windows 代理。

#### 任务 1：配置 Azure DevOps 项目并初始化代码存储库

完成以下步骤以配置 Azure DevOps 项目。

1. 打开浏览器窗口，然后导航到 Azure 门户：`https://portal.azure.com/`。

1. 在顶部的搜索栏中，在“搜索”文本框中输入“devops”****

1. 在搜索结果中，选择“Azure DevOps 组织”。****

1. 选择“我的 Azure DevOps 组织”。****

1. 在“我们需要更多详细信息”页上，选择“继续”****。

1. 在“Azure DevOps 入门”页上，选择“创建新组织”，然后选择“继续”********。

1. 在“几乎完成”页上，输入显示的字符，然后选择“继续****”。

1. 在 Azure DevOps 组织页上，选择“组织设置”****。

1. 在左侧菜单中的“安全性”下，选择“策略”。********

1. 将“允许公共项目”设置为****“启用”，然后选择“保存”。********

1. 导航回 DevOps 组织页面。

1. 在“创建一个开始使用的项目”下，输入以下信息：

    - 项目名称：AZ2003Project****
    - 说明：AZ2003 代码项目****
    - 可见性：公共****

1. 选择“创建项目”。

1. 在 AZ2003Project 页面的左侧菜单中，选择“Repos”****。

1. 在“使用 README 或 gitignore 初始化主分支”下选择“初始化”。****

1. 选择“克隆”****，然后选择“在 VS Code 中克隆”****。

1. 在“此站点正在尝试打开 Visual Studio Code”对话框中，选择“打开”****。

1. 在“允许扩展打开此 URI”对话框中，选择“打开”****。

1. 在“选择要克隆的文件夹”窗口中，选择“桌面”****，选择“新建文件夹”****，键入“AZ2003”****，然后按 Enter。

1. 选择“选择作为存储库目标”****。

1. 在“是否要打开克隆的存储库”对话框中，选择“打开”****，然后选择“是，我信任创建者”****。

#### 任务 2：创建 .NET 应用并同步到 Azure DevOps 存储库

完成以下步骤来创建 .NET 应用并同步到 Azure DevOps 存储库。

1. 在 Visual Studio Code 的“终端”菜单上，选择“新建终端”****。

1. 在终端命令提示符处，若要验证 .NET SDK 是否已正确安装，请输入以下命令：

    ```dotnetcli
    dotnet --version
    ```

    如果收到一条错误，指出无法识别术语“dotnet”，请完成以下操作：

    - 在 Windows 的“开始”菜单上，打开 Windows 的“设置”****。
    - 在“设置”中，打开“应用”**** 选项卡，然后选择“已安装的应用”****。
    - 在已安装应用的列表中找到“Microsoft .NET SDK 8.0.100 (x64)”****。
    - 在 Microsoft .NET SDK 8.0.100 (x64) 右侧，选择省略号 (...)，然后选择“修改”****。
    - 若要允许应用进行更改，请选择“是”****。
    - 在 Microsoft .NET SDK 8.0.100 窗口中，选择“修复”****。
    - 等待修复操作成功完成，然后选择“关闭****”。
    - 关闭设置窗口。
    - 切换回 Visual Studio Code 窗口，然后关闭 Visual Studio Code。
    - 重新打开 Visual Studio Code。
    - 在 Visual Studio Code 的“终端”的命令提示符处输入 `dotnet --version`
    - 应会看到显示的版本号。 例如：8.0.100****。

1. 在终端命令提示符处，若要配置 Git 电子邮件设置，请使用以下命令：

    输入“git config --global user.email”****，然后输入在实验室环境中提供的帐户电子邮件信息

    例如 git config --global user.email LabUser-12345678@labhoster.onmicrosoft.com

1. 在终端命令提示符处，若要配置 Git 用户名，请使用以下命令：

    输入“git config --global user.name”****，然后输入在实验室环境中提供的帐户用户名信息

    例如 git config --global user.name LabUser-12345678

1. 在“视图”菜单中，选择“命令面板”****。

1. 在命令提示符处，选择“.NET:**** 新建项目”，然后选择“ASP.NET Core 空”****。

1. 等待资源加载，然后输入以下信息：

    - 在“命名新项目”文本框中，输入“AZ2003App”****
    - 接受默认目录。

1. 打开终端命令提示符，然后运行以下 dotnet CLI 命令：

    ```dotnetcli
    dotnet build
    ```

1. 在根项目文件夹中，创建一个包含以下信息的 .gitignore 文件：

    ```gitignore
    [Bb]in/
    [Oo]bj/
    ```

1. 在“文件”菜单中，选择“全部保存”。****

1. 打开“源代码管理”视图。

1. 在提交消息文本框中，输入“初始提交”****。

1. 选择“提交”****，然后选择“是”**** 以暂存并提交更改。

1. 选择“同步更改”****，然后选择“确定”**** 以将文件同步到 DevOps 存储库。

1. 在“Git 凭据管理器”对话框中，输入实验室环境凭据（用户名和密码）。

#### 任务 3：创建 Docker 映像并将该映像推送到 Azure 容器注册表

完成以下步骤，创建 Docker 映像并将该映像推送到 Azure 容器注册表。

1. 确保在 Visual Studio Code 中打开了你的 AZ2003 代码项目。

1. 若要创建 Dockerfile，请从命令面板运行以下命令：Docker:**** 将 Docker 文件添加到工作区。

1. 出现提示时，执行以下信息：

    - 应用程序平台：.NET ASP.NET Core。****
    - 操作系统：Linux。****
    - 端口：5000。****
    - 包括 Docker Compose 文件：**否**

1. 若要创建 Docker 映像，请在命令面板中运行以下命令：Docker 映像:**** 生成映像。

1. 等待映像生成过程完成，然后关闭“终端”。

1. 在左侧菜单中，若要打开“Docker”视图，请选择“Docker”。

1. 在“DOCKER”视图中的“注册表”下，选择“连接注册表”****，然后选择“Azure 容器注册表”****。

1. 在“DOCKER”视图中，展开“Azure”****，然后选择“允许”****。

1. 在浏览器窗口中，选择用于本实验室的 Azure 帐户。

1. 返回到 Visual Studio Code。

1. 在“DOCKER”视图中，展开 Azure 订阅，并验证是否列出了已创建的 Azure 容器注册表。

1. 若要将 Docker 映像推送到 Azure 容器注册表，请在命令面板中运行以下命令：Docker 映像:**** 推送”。

1. 当该命令运行时，完成以下步骤：

    - 选择映像组：选择“az2003project”****
    - 选择映像（标记）：选择“最新”****
    - 选择注册表提供者：选择“Azure”****
    - 选择订阅。
    - 选择要将映像推送到其中的 Azure 容器注册表：选择已创建的容器注册表。 例如 acraz2003cah12oct。
    - 若要部署映像，请按 Enter。

1. 等待映像推送过程完成，然后关闭“终端”。

1. 打开“源代码管理”视图，输入提交消息，然后选择“提交”和“同步更改”。********

#### 任务 4：创建一个名为 Pipeline1 的 Azure 管道

完成以下步骤，以创建一个名为 Pipeline1 的 Azure 管道。

1. 打开 Azure DevOps 项目。

1. 在左侧菜单中，选择“管道”。****

1. 选择“Create Pipeline”。

1. 选择“Azure Repos Git”。

1. 在“选择存储库”页上，选择“AZ2003Project”。****

1. 选择“初学者管道”。

1. 在“保存并运行”下，选择“保存”，然后选择“保存”。********

1. 若要将管道的名称更改为“Pipeline1”，请完成以下步骤：

    1. 在左侧菜单中，选择“管道”。****

    1. 在 AZ2003Project 管道右侧，选择“更多选项”，然后选择“重命名/移动”。********

    1. 在“重命名/移动管道”对话框中，在“名称”下输入 Pipeline1，然后选择“保存”。********

#### 任务 5：部署自托管 Windows 代理

要使 Azure 管道构建和部署 Windows、Azure 和其他 Visual Studio 解决方案，主机环境中至少需要有一个 Windows 代理。

完成以下步骤来部署自托管 Windows 代理。

1. 导航到 DevOps 组织的主页。

1. 在右上角选择“用户设置”****。

1. 在“用户设置”对话框中，选择“个人访问令牌”****。

1. 若要创建个人访问令牌，请选择“+ 新建令牌”****。

1. 在“名称”下输入“AZ2003”。****

1. 在“创建新的个人访问令牌”窗口的底部，若要查看完整的范围列表，请选择“显示所有范围”****。

1. 对于作用域，选择“代理池(读取、管理)”和“部署组(读取、管理)”。********

    确保清除所有其他框。

1. 选择**创建**。

1. 在“成功”页上，若要复制令牌，请选择“复制到剪贴板”，然后选择“关闭”。********

1. 打开记事本，然后将令牌的副本保存到记事本。

    配置代理时，将使用此令牌。

1. 导航到 DevOps 组织，然后选择“组织设置****”。

1. 在左侧菜单中，在“管道”下选择“代理池”。****

1. 如果“获取代理”**** 对话框打开，请跳至下一步，否则请完成以下步骤：

    1. 若要选择默认池，请选择“默认”。****

        ******** 如果默认池不存在，请选择“添加池”，然后输入以下信息：

        1. 在“池类型”下，选择“自托管”。****

        1. 在“名称”下，输入“默认”****

        1. 选择**创建**。

        1. 若要打开刚刚创建的池，请选择“默认”。****

    1. 在“默认”下选择“代理”**** 选项卡，然后选择“新建代理”****。

1. 在“获取代理”对话框中，完成以下步骤：

    1. 选择“Windows”选项卡。****

    1. 在左侧窗格中选择“x64”****。

    1. 在右侧窗格中选择“下载”****。

1. 请等待下载完成。

1. 关闭“获取代理”对话框。

    接下来的一系列说明步骤将引导你完成“创建代理”过程。

1. 使用 Windows 文件资源管理器为代理创建以下文件夹位置：

    ```dos
    C:\agents
    ```

1. 使用 Windows 文件资源管理器将下载的代理 zip 文件解压缩到刚创建的代理目录中。

1. 等待文件提取过程完成，然后关闭文件资源管理器。

1. 以管理员身份打开 Windows PowerShell，导航到代理目录，然后输入以下 PowerShell 命令：

    ```powershell
    .\config
    ```

1. 响应配置提示，如下所述：

    - 输入服务器 URL >：输入你的 DevOps 组织的 URL。 例如：`https://dev.azure.com/<your organization>`
    - 输入身份验证类型(要输入 PAT，请按 Enter) >：按 Enter。
    - 输入个人访问令牌 >：粘贴已复制到记事本的个人访问令牌。
    - 输入代理池(要输入默认池，请按 Enter) >：按 Enter。
    - 输入代理名称(要输入你的电脑名称，请按 Enter) > 输入“az2003-agent”****
    - 输入工作文件夹(要输入 _work，请按 Enter) >：按 Enter。
    - 输入“将代理作为服务运行?” (Y/N) (要输入 N，请按 Enter) >：输入 Y****
    - 输入是否为代理服务启用 SERVICE_SID_TYPE_UNRESTRICTED (Y/N) (要输入 N，请按 Enter) >：输入 Y****
    - 输入要用于服务的用户帐户(要输入 NT AUTHORITY\NETWORK SERVICE，请按 Enter) >：按 Enter。
    - 输入是否阻止在配置完成后立即启动服务？ (Y/N) (要输入 N，请按 Enter) >：按 Enter。

    一条消息通知你代理已成功启动。

    有关更多帮助信息，请参阅以下文档：`https://learn.microsoft.com/azure/devops/pipelines/agents/windows-agent`

1. 关闭 Windows PowerShell。

### 练习 4：配置 Azure 容器注册表来与 Azure 容器应用建立安全连接

系统已要求你配置满足以下要求的 Azure 资源：

- 资源组必须包含用户分配的托管标识。
- 容器注册表必须能够使用托管标识来拉取项目。
- 必须使用最小特权原则限制托管标识的访问权限。
- 必须可以从 VNET1/PESubnet 上的专用终结点访问容器注册表。

在本练习中，你将配置一个容器注册表实例来与容器应用建立安全连接。

完成以下任务大约需要 10 分钟：

- 配置用户分配的托管标识。
- 使用托管标识的 AcrPull 权限配置容器注册表。
- 使用专用终结点连接配置容器注册表。

#### 任务 1：配置用户分配的托管标识

完成以下步骤来配置用户分配的托管标识。

1. 打开 Azure 门户。

1. 在 Azure 门户的顶部搜索栏中，输入“托管标识”****

1. 在筛选后的资源列表中，选择“用户分配的托管标识”。****

1. 在“创建用户分配的托管标识”页上，指定以下信息：

    - 订阅：选择用于此引导项目的 Azure 订阅。
    - 资源组：**RG1**
    - 区域：输入与资源组的区域设置匹配的区域。
    - 名称：uai-az2003****

1. 选择“查看 + 创建”。

1. 在验证设置时等待，然后选择“创建****”。

1. 关闭托管标识页。

#### 任务 2：使用托管标识的 AcrPull 权限配置容器注册表

完成以下步骤，使用托管标识的 AcrPull 权限配置容器注册表。

1. 在 Azure 门户中，打开你的容器注册表资源。

1. 在左侧菜单中，选择“访问控制(IAM)”。****

1. 在“访问控制(IAM)”页中，选择“添加角色分配”。****

1. 搜索 AcrPull 角色，然后选择“AcrPull”。****

1. 选择**下一步**。

1. 在“成员”选项卡中，在“将访问权限分配给”的右侧选择“托管标识”。****

1. 选择“+ 选择成员”。

1. 在“选择托管标识”页上的“托管标识”下，选择“用户分配的托管标识”，然后选择为此项目创建的用户分配的托管标识。****

    例如 uai-az2003。

1. 在“选择托管标识”页上，选中“选择”。****

1. 在“添加角色分配”页的“成员”选项卡上，单击“审阅 + 分配”。****

1. 在“查看 + 分配”选项卡上，选择“查看 + 分配”****。

1. 等待添加角色分配。

    将出现一条通知，但如果错过了它，你可以检查“角色分配”选项卡，以验证是否已为 uai-az2003 分配 AcrPull 角色。

#### 任务 3：使用专用终结点连接配置容器注册表

完成以下步骤，以使用专用终结点连接配置容器注册表。

1. 确保容器注册表资源在门户中打开。

1. 在“设置”下选择“网络”。****

1. 在“专用访问”选项卡上，选择“+ 创建专用终结点连接”。****

1. 在“基本信息”选项卡上的“项目详细信息”下，指定以下信息：

    - 订阅：选择用于此引导项目的 Azure 订阅。
    - 资源组：**RG1**
    - 名称：pe-acr-az2003****
    - 区域：确保指定的“区域”与资源组的区域设置匹配。

1. 在完成时选择“下一步:资源”。

1. 在“资源”选项卡上，确保显示以下信息：

    - 订阅：确保已选择用于此引导项目的 Azure 订阅。
    - 资源类型：确保已选择 Microsoft.ContainerRegistry/registries。****
    - 资源：确保已选择注册表的名称。
    - 目标子资源：确保已选择注册表。****

1. 选择“下一步: 虚拟网络”。

1. 在“虚拟网络”选项卡上的“网络”下，确保显示以下信息：

    - 虚拟网络：确保选中“VNET1”
    - 子网：确保选中“PESubnet”。

1. 选择“下一步: DNS”。

1. 在“DNS”选项卡上的“专用 DNS集成”下，确保显示以下信息：

    - 与专用 DNS 区域集成：确保选中“是”****。
    - 专用 DNS 区域：请注意，指定了“(新) privatelink.azurecr.io”。****

1. 在完成时选择“下一步:  标记”。

1. 在完成时选择“下一步:  查看 + 创建”。

1. 在“查看 + 创建”选项卡上，当看到“验证通过”消息时，请选择“创建”。****

1. 等待部署完成。

1. 看到“部署已完成”**** 时，请关闭专用终结点部署页。

### 练习 5：在 Azure 容器应用中创建和配置容器应用

你被要求配置一个满足以下要求的容器应用：

- 部署到 VNET1/ACASubnet。
- 从容器注册表拉取映像。
- 使用用户分配的托管标识 (uai-az2003) 进行身份验证。
- 使用容器应用通过 .NET 客户端类型连接到服务总线实例。
- 每次有 1000 个并发 HTTP 请求时，应用都最多可运行两个已添加的副本。

在本练习中，需将容器应用从 Azure 容器注册表中的映像部署到 Azure 容器应用平台。

完成以下任务大约需要 20-25 分钟：

- 创建一个使用 Azure 容器注册表映像的容器应用。
- 将容器应用配置为使用用户分配的标识进行身份验证。
- 配置容器应用与服务总线之间的连接。
- 配置 HTTP 缩放规则。

#### 任务 1：创建一个使用 Azure 容器注册表映像的容器应用

完成以下步骤来创建一个使用 Azure 容器注册表映像的容器应用。

1. 在 Azure 门户的顶部搜索栏中，输入“容器应用”****

1. 在筛选的资源列表中，选择“容器应用****”。

1. 在“容器应用”页上，选择“创建容器应用”。****

1. 在“基本信息”选项卡上，指定以下内容：

    - 订阅：选择用于此引导项目的 Azure 订阅。
    - 资源组：**RG1**
    - 容器应用名称：aca-az2003****
    - 区域：确保指定的“区域”与 VNET1 的区域设置匹配（后者应与资源组位置匹配）。

        容器应用需要与虚拟网络位于同一区域/位置，以便你可以为托管环境选择 VNET1。 对于此引导项目，请将所有资源保留在为资源组指定的区域/位置。

    - 容器应用环境：选择“新建”****。

1. 在“创建容器应用环境”页上，选择“网络”选项卡，然后指定以下内容：****

    - 使用自己的虚拟网络：选择“是”****。
    - 虚拟网络：选择“VNET1”。****
    - 基础结构子网：ACASubnet。****

    > [!NOTE]
    > 如果未列出 ACASubnet 子网，请取消此创建过程，打开虚拟网络资源，将 ACASubnet 地址范围调整为 10.0.2.0/23****，然后重新开始创建容器应用资源的步骤。

1. 在“创建容器应用环境”页上，选择“创建”。****

1. 在“创建容器应用”页上，选择“容器”选项卡，然后指定以下内容：

    - 使用快速入门映像：取消选中此设置。****
    - 名称：确保指定 aca-az2003****。
    - 映像源：确保选中“Azure 容器注册表”。****
    - 注册表：选择你的容器注册表。 例如 acraz2003cah12oct.azurecr.io****
    - 图像：选择“az2003project”****
    - 映像标记：选择“最新”****

1. 选择“查看 + 创建”。

1. 在验证通过后，选择“创建”。****

1. 等待部署完成。

    > [!NOTE]
    > 此部署可能需要 5-10 分钟才能完成。

#### 任务 2：将容器应用配置为使用用户分配的标识进行身份验证

完成以下步骤，将容器应用配置为使用用户分配的标识进行身份验证。

1. 在 Azure 门户中，打开创建的容器应用。

1. 在“设置”下，选择“标识”。****

1. 选择“用户分配”选项卡。****

1. 选择“添加用户分配的托管标识”。****

1. 在“添加用户分配的托管标识”页上，选择“uai-az2003”，然后选择“添加”。********

#### 任务 3：配置容器应用与服务总线之间的连接

完成以下步骤，配置容器应用与服务总线之间的连接。

1. 在 Azure 门户中，确保已打开容器应用。

1. 在“设置”下，选择“服务连接器(预览版)”。****

1. 选择“服务连接”。****

1. 在“创建连接”页上，指定以下内容：

    - 服务类型：选择“服务总线”。****
    - 客户端类型：选择“.NET”****。

1. 选择“下一步: 身份验证”。

1. 在“身份验证”选项卡上，选择“用户分配的托管标识”。****

1. 若要更改选项卡，请选择“查看 + 创建”。****

1. 显示“已通过验证”消息后，选择“创建”。****

1. 等待创建连接。

     服务总线连接将在“服务连接器(预览)”页面上列出。

#### 任务 4：配置 HTTP 缩放规则

完成以下步骤，为容器应用配置 HTTP 缩放规则。

1. 确保容器应用在门户中打开。

1. 在左侧菜单中的“应用程序”下，选择“修订和副本”。****

1. 请注意分配给有效修订的名称。

1. 在左侧菜单中的“应用程序”下，选择“缩放”****。

1. 在页面顶部，选择“编辑和部署”。****

1. 在页面底部，选择“下一步: **** 缩放”。

1. 配置最小/最大副本数，如下所示：

    - 设置最小副本数：0
    - 设置最大副本数：2

1. 在“缩放规则”下，选择“+ 添加”。****

1. 在“添加缩放规则”页上，指定以下内容：

    - 规则名称：输入 scalerule-http****
    - 类型：选择“HTTP 缩放”。****
    - 并发请求数：将值设置为 1000****。

1. 在“添加缩放规则”页上，选择“添加”。****

1. 在“创建和部署新的修订”页上，选择“创建”。****

1. 确保显示新的缩放规则。

    如果刷新后未显示缩放规则，请检查“修订”选项卡以查看当前的活动修订，然后根据需要在“缩放和副本”页面上调整所选修订。

### 练习 6：使用 Azure Pipelines 配置持续集成

系统要求你为容器应用配置满足以下要求的持续集成环境：

- 你的 ADO 环境中需要有一个 Azure 容器应用部署任务。
- Pipeline1 必须使用自托管代理池将容器映像从容器注册表部署到容器应用。
- 你必须确保管道至少将映像成功部署一次。

在本练习中，你将容器应用从 Azure 容器注册表中的映像部署到 Azure 容器应用平台。

完成以下任务大约需要 10 分钟：

- 将 Pipeline1 配置为使用自托管代理池。
- 为 Pipeline1 配置 Azure 容器应用部署任务。
- 运行 Pipeline1 部署任务。

#### 任务 1：将 Pipeline1 配置为使用自托管代理池

完成以下步骤，将管道配置为使用自托管代理池。

1. 确保 Azure DevOps 组织在其自己的浏览器标签页上打开。

    根据需要打开新的浏览器标签页，导航到 `https://dev.azure.com`，然后打开 Azure DevOps 组织。

1. 在 Azure DevOps 页上，若要打开 DevOps 项目，请选择“AZ2003Project”****。

1. 在左侧菜单中，选择“管道”。****

1. 选择“Pipeline1”****，然后选择“编辑”****。

1. 若要使用自托管代理池，请更新 azure-pipelines.yml 文件，如以下示例所示：

    ```yml
    trigger:
    - main

    pool:
      name: default

    steps:

    ```

1. 选择“保存”。

1. 键入提交消息，然后选择“保存”。****

#### 任务 2：为 Pipeline1 配置 Azure 容器应用部署任务

完成以下步骤，以使用 Azure 容器应用部署任务配置 Pipeline1。

1. 确保已打开 Pipeline1 进行编辑。

1. 在“任务”下的右侧，在“搜索任务”字段中，输入“azure 容器”****

1. 在筛选出的任务列表中，选择“Azure 容器应用部署”****

1. 在 Azure 资源管理器连接下，选择你正在使用的订阅，然后选择“授权”。****

1. 在“Azure 门户”选项卡中，打开你的容器应用资源，然后打开“容器”页。

1. 将以下信息复制到记事本。

    - 名称
    - 注册表
    - 映像
    - 映像标记

1. 使用从“容器”页复制的信息来配置以下“任务信息”字段：

    - 要部署的 Docker 映像：注册表/映像：映像标记（替换为来自记事本的信息）
    - Azure 容器应用名称：名称（替换为来自记事本的信息）

    例如：

    - 要部署的 Docker 映像：acraz2003cah12oct.azurecr.io/az2003project:latest
    - Azure 容器应用名称：aca-az2003

1. 在“Azure 资源组名称”字段中，输入“RG1”****

    > [!NOTE]
    > 如果你需要验证资源组名称，可以在容器应用资源的“概述”页上找到它。

1. 在“Azure 容器应用部署”页上，选择“添加”。****

    管道的 Yaml 文件现在应当包括 AzureContainerApps 任务，如下所示：

    ```yml
    trigger:
    - main
    pool:
      name: default
    steps:
    - task: AzureContainerApps@1
      inputs:
        azureSubscription: '<Subscription>(<Subscription ID>)'
        imageToDeploy: '<Registry>/<Image>:<Image tag>' from Container App resource
        containerAppName: '<Name>' from Container App resource 
        resourceGroup: '<resource group name>'
    
    ```

    下面是显示了 YAML 配置代码片段的一个示例：

    ```yml
    trigger:
    - main
    pool:
      name: default
    steps:
    - task: AzureContainerApps@1
      inputs:
        azureSubscription: 'Visual Studio Enterprise(1111aaaa-22bb-33cc-44dd-555555eeeeee)'
        imageToDeploy: 'acraz2003cah12oct.azurecr.io/aspnetcorecontainer:latest'
        containerAppName: 'aca-az2003'
        resourceGroup: 'RG1'
    ```

1. 在 Pipeline1 页上，选择“保存”****，输入提交消息，然后再次选择“保存****”进行提交。

#### 任务 3：运行 Pipeline1 部署任务

完成以下步骤，以运行 Pipeline1 部署任务。

1. 确保你已在 Azure DevOps 中打开 Pipeline1。

1. 若要运行 AzureContainerApps 任务，请选择“运行”。****

1. 在“运行管道”页上，选择“运行”。****

    此时会打开管道页以显示关联的作业。 作业部分会显示作业状态，其进度为从“已排队”到“正在等待”。

1. 查看“需要的权限”是否显示在“作业”下。

    如果作业需要权限才能继续运行，请选择“查看”****，然后选择“允许”**** 以提供所需的权限。

1. 监视运行操作的状态，并验证运行是否成功。

    排队的作业可能需要几分钟的时间才能开始运行。 一分钟左右后，作业状态应从“正在运行”更改为“成功”。

### 练习 7：在 Azure 容器应用中管理修订

为容器应用配置流量拆分需要满足以下要求：

- 需要创建带有 v2 后缀的容器应用的新修订。
- 必须确保 25% 的应用请求指向 v2 修订。
- 必须将修订标记为“current”和“updated”，并确保对“--updated”修订的请求指向标记为“v2”的修订。

在本练习中，你将部署容器应用的新修订，并在两个标记修订之间配置流量拆分。

完成以下任务大约需要 5-10 分钟：

- 将修订管理设置为多修订。
- 创建带有 v2 后缀的新修订。
- 配置修订标签。
- 配置修订的流量百分比。

#### 任务 1：将修订管理设置为多修订

完成以下步骤，将修订管理设置为多修订。

1. 在 Azure 门户中，打开容器应用资源。

1. 在左侧菜单中的“应用程序”下，选择“修订和副本”。****

1. 在“修订”页面顶部，选择“选择修订模式”****。

1. 若要从单修订模式切换到多修订模式，请选择“确认”****。

1. 在“修订”页面上，等待“修订模式”设置更新****。

    更新完成后，修订模式将设置为“多修订”。****

#### 任务 2：创建带有 v2 后缀的新修订

完成以下步骤，创建带有 v2 后缀的新修订。

1. 在 Azure 门户中，确保已打开容器应用资源的“修订”页面。

1. 在页面顶部，选择“+ 创建新的修订”****。

1. 在“创建和部署新的修订”页面上，完成以下步骤：

    - 名称/后缀：输入“v2”****
    - 在“容器映像”下，选择容器映像。 例如 aca-az2003。

1. 选择**创建**。

1. 等待部署完成。

#### 任务 3：配置修订标签

必须先启用入口，然后才能配置修订标签或流量拆分。

完成以下步骤，在修订上配置标签。

1. 在左侧菜单的“设置”下，选择“流入量”。****

1. 如果未启用流入量，请选择“启用”****。

1. 在“流入量”页面上，指定以下信息：

    - 入口流量：选择“接受来自任何位置的流量”****。

    - 入口类型：选择“HTTP”****。

    - 客户端证书模式：确保已选中“忽略”****。

    - 传输：确保已选中“自动”****。

    - 不安全的连接：确保未选中“允许”****。

    - 目标端口：输入“5000”****

    - IP 安全限制模式：确保已选中“允许所有流量”****。

1. 在“流入量”页面底部，选择“保存”，然后等待更新完成****。

1. 在左侧菜单中的“修订”下，选择“修订和副本”****。

1. 对于 v2 修订，请在“标签”下输入“updated”****

1. 对于其他修订，请输入“current”****

1. 在页面顶部，选择“保存”。

1. 等待“入口”设置更新。

#### 任务 4：配置修订的流量百分比

完成以下步骤，配置修订的流量百分比。

1. 确保已打开“修订”页。

1. 对于 v2 修订，在“流量”下的百分比中输入“25”****。

1. 对于其他修订，在“流量”下的百分比中输入“75”****。

1. 在页面顶部，选择“保存”。
